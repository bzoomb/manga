name: custom

on:
  workflow_dispatch:
    inputs:
      single_index:
        description: 'Single index to process (e.g., 5)'
        required: false
        type: string
      index_range:
        description: 'Index range to process (e.g., 3-13)'
        required: false
        type: string

permissions:
  contents: write

jobs:
  process_manga:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          pip install mangadex-downloader

      - name: Determine Indices
        id: determine_indices
        run: |
          if [[ -n "${{ github.event.inputs.single_index }}" ]]; then
            echo "start_index=${{ github.event.inputs.single_index }}" >> $GITHUB_OUTPUT
            echo "end_index=${{ github.event.inputs.single_index }}" >> $GITHUB_OUTPUT
          elif [[ -n "${{ github.event.inputs.index_range }}" ]]; then
            IFS='-' read -ra RANGE <<< "${{ github.event.inputs.index_range }}"
            echo "start_index=${RANGE[0]}" >> $GITHUB_OUTPUT
            echo "end_index=${RANGE[1]}" >> $GITHUB_OUTPUT
          elif [[ -f last_index.txt ]]; then
            last_index=$(cat last_index.txt)
            echo "start_index=$((last_index + 1))" >> $GITHUB_OUTPUT
            echo "end_index=$((last_index + 1))" >> $GITHUB_OUTPUT
          else
            echo "start_index=1" >> $GITHUB_OUTPUT
            echo "end_index=1" >> $GITHUB_OUTPUT
          fi

      # ... (rest of the steps remain the same until the Send Telegram Notification step)

      - name: Send Telegram Notification
        if: steps.get_urls.outputs.workflow_complete != 'true'
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # Create the message content
          cat << EOF > message.txt
          Manga Upload Successful!

          -----

          $(while IFS='|' read -r title filename index size link1 link2; do
            echo "Title: ${title}"
            echo "File name: ${filename}"
            echo "Index: ${index}"
            echo "Size: ${size}"
            echo "Link1: ${link1}"
            echo "Link2: ${link2}"
            echo
            echo "-----"
            echo
          done < upload_info.txt)
          
          Workflow ended at $(TZ='Asia/Jakarta' date "+%Y-%m-%d %H:%M:%S %Z")
          EOF

          # Send the message
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
               -H "Content-Type: application/json" \
               -d @- << EOF
          {
            "chat_id": "${TELEGRAM_CHAT_ID}",
            "text": $(jq -Rs . < message.txt),
            "parse_mode": "HTML"
          }
          EOF
